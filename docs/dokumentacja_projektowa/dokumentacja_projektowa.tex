\documentclass[12pt,a4paper,oneside]{article}

\usepackage[QX]{polski}

\usepackage[utf8]{inputenc}
\usepackage{latexsym}
\usepackage{tgpagella}
\usepackage{lmodern}
\usepackage{amsmath,amsthm,amsfonts,amssymb,alltt}
\usepackage{epsfig}
\usepackage{graphicx}
\usepackage{pdflscape}
\usepackage{caption}
\usepackage{indentfirst}
\usepackage{float}
%\usepackage{showkeys}
\bibliographystyle{plabbrv}


\usepackage{color}
\usepackage[polish]{babel}
\usepackage{datetime2}
\usepackage[x11names,dvipsnames,table]{xcolor}
\usepackage{hyperref}
\hypersetup{
pdfauthor={Dawid Plata, Michał Szymbara, Michał Wechmann},
colorlinks=True,
linkcolor=darkgray,  % color of internal links (change box color with linkbordercolor)
citecolor=BrickRed,  % color of links to bibliography
filecolor=Magenta,   % color of file links
urlcolor=BlueViolet}	%%pdfpagemode=FullScreen}

% diagramy, grafy itp.
\usepackage{tikz}
\usetikzlibrary{positioning}
\usetikzlibrary{arrows}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{chains,fit,shapes,calc}
\tikzset{main node/.style={circle,fill=blue!20,draw,minimum size=1cm,inner sep=0pt}}

% algorytmy
\usepackage[linesnumbered,lined,commentsnumbered]{algorithm2e}
\SetKwFor{ForEach}{for each}{do}{end for}%
\SetKwFor{ForAll}{for all}{do}{end for}%
\newenvironment{myalgorithm}
{\rule{\textwidth}{0.5mm}\\\SetAlCapSty{}\SetAlgoNoEnd\SetAlgoNoLine\begin{algorithm}}{\end{algorithm}\rule{\textwidth}{0.5mm}}


%---------------------
\overfullrule=2mm
\pagestyle{plain}
\textwidth=15cm \textheight=685pt \topmargin=-25pt \linespread{1.3} 
\setlength{\parskip}{0pt}
\setlength\arraycolsep{2pt}
\oddsidemargin = 0.9cm
\evensidemargin =-0.1cm

\captionsetup{width=.95\linewidth, justification=centering}
%---------------------




\newtheorem{tw}{Twierdzenie}[section]
\newtheorem{lem}[tw]{Lemat}
\newtheorem{co}[tw]{Wniosek}
\newtheorem{prop}[tw]{Stwierdzenie}
\theoremstyle{definition}
\newtheorem{ex}{Przykład}
\newtheorem{re}[tw]{Uwaga}
\newtheorem{de}{Definicja}[section]



\newcommand{\bC}{{\mathbb C}}
\newcommand{\bR}{{\mathbb R}}
\newcommand{\bZ}{{\mathbb Z}}
\newcommand{\bQ}{{\mathbb Q}}
\newcommand{\bN}{{\mathbb N}}
\newcommand{\captionT}[1]{\caption{\textsc{\footnotesize{#1}}}}
\renewcommand\figurename{Rys.}

% Pokazuj poziom paragraph w spisie treści i numeracji
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}

\numberwithin{equation}{section}
\renewcommand{\thefootnote}{\arabic{footnote})}
%\renewcommand{\thefootnote}{\alph{footnote})}



\begin{document}

% --------------------------------------------
% Strona tytułowa
% --------------------------------------------

\thispagestyle{empty}
\begin{titlepage}
\begin{center}\Large
Uniwersytet Komisji Edukacji Narodowej w Krakowie\\
\large
Instytut Bezpieczeństwa i Informatyki\\
\vskip 10pt
\end{center}
\begin{center}
\centering \includegraphics[width=1.0\columnwidth]{images/logo.png}
\end{center}

\begin{center}
 {\bf \fontsize{14pt}{14pt}\selectfont PROJEKT INŻYNIERSKI \\ DOKUMENTACJA PROJEKTOWA}
\end{center}
\vskip 5pt
\begin{center}
 {\bf \fontsize{22pt}{22pt}\selectfont System WasteFree Cloud do efektywnego zarządzania odpadami}
\end{center}



\begin{center}
 {\fontsize{12pt}{12pt}\selectfont wykonany przez: }
\end{center}
\begin{center}
 {\bf\fontsize{16pt}{16pt}\selectfont Dawid Plata}\\
 {\fontsize{12pt}{12pt}\selectfont Nr albumu: 165303 \\\&\\}
 {\bf\fontsize{16pt}{16pt}\selectfont Michał Szymbara}\\
 {\fontsize{12pt}{12pt}\selectfont Nr albumu: 165297\\\&\\}
 {\bf\fontsize{16pt}{16pt}\selectfont Michał Wechmann}\\
 {\fontsize{12pt}{12pt}\selectfont Nr albumu: 165298}
\end{center}
\begin{center}
 {\fontsize{12pt}{12pt}\selectfont pod opieką:}\\
 {\bf\fontsize{12pt}{12pt}\selectfont dr Wojciech Gwizdała}\\
 {\bf\fontsize{12pt}{12pt}\selectfont mgr Wojciech Baran}
\end{center}

%\mbox{}
\vspace*{\fill}
%\vskip 50pt
\begin{center}
\large
Kraków \the\year\\
(ostatnia aktualizacja: \DTMcurrenttime,\;\today)
\end{center}
\end{titlepage}
\setcounter{page}{0} 
\newpage\null\thispagestyle{empty}
%\setcounter{page}{0} 
%\newpage
%\thispagestyle{empty}

\tableofcontents


\newpage

\section{Dokumentacja projektowa}
\subsection{Projekt UML}
Rysunek \ref{fig:domain-model} przedstawia główny model domenowy systemu WasteFree, w którym wszystkie encje dziedziczą po \textit{DatabaseEntity} (identyfikator i metadane audytowe). Model pokazuje relacje użytkowników z grupami, zamówieniami odbioru odpadów, portfelem oraz szablonami powiadomień.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.97\textwidth]{../diagrams/domain-model/domain-model.png}
	\caption{Model domenowy i powiązania encji}
	\label{fig:domain-model}
\end{figure}

Kluczowe zależności:
\begin{itemize}
	\item \textbf{User} — posiada role, preferencje językowe, status aktywności oraz jest właścicielem \textbf{Wallet} i powiązany z \textbf{InboxNotification}. Użytkownik dołącza do \textbf{GarbageGroup} poprzez \textbf{UserGarbageGroup} (rola w grupie, stan oczekiwania).
	\item \textbf{GarbageGroup} — prywatne lub publiczne grupy adresowe, mają wiadomości \textbf{GarbageGroupMessage} oraz zamówienia \textbf{GarbageOrder}. Administrator może wymagać \textbf{GarbageAdminConsent}.
	\item \textbf{GarbageOrder} — definiuje parametry odbioru (opcja, rozmiar kontenera, daty, priorytet, status, koszty) i jest powiązany z uczestnikami \textbf{GarbageOrderUsers}; może wskazywać przydzielonego admina grupy.
	\item \textbf{Wallet} i \textbf{WalletTransaction} — ewidencja środków i operacji finansowych użytkownika.
	\item \textbf{NotificationTemplate} oraz \textbf{InboxNotification} — wzorce treści i konkretne powiadomienia (kanał, typ, język).
\end{itemize}

\subsection{Projekt bazy danych}
Implementacja relacyjna odwzorowuje powyższy model: tabelom odpowiadają encje domenowe, a klucze obce odzwierciedlają relacje przedstawione na diagramie. Kluczowe elementy schematu:
\begin{itemize}
	\item Tabele użytkownika, portfela i transakcji zabezpieczają integralność środków (powiązanie 1:1 \textbf{User}–\textbf{Wallet}, 1:N \textbf{Wallet}–\textbf{WalletTransaction}).
	\item Grupy i członkostwa: tabela \textbf{GarbageGroup} z łącznikiem \textbf{UserGarbageGroup} (rola, stan) oraz wiadomościami \textbf{GarbageGroupMessage}.
	\item Zamówienia odbioru: \textbf{GarbageOrder} wraz z tabelą uczestników \textbf{GarbageOrderUsers}; powiązanie z grupą i ewentualnym adminem.
	\item Powiadomienia: \textbf{NotificationTemplate} (kanał, typ, język) i \textbf{InboxNotification} (wiadomości przypisane użytkownikowi, typ akcji, powiązana encja).
	\item Metadane audytowe i klucze główne: wspólne pola z \textbf{DatabaseEntity} (Id, utworzenie/modyfikacja, autorzy) ułatwiają spójność oraz migracje.
\end{itemize}

\section{Deploymenty}
\subsection{Środowisko deweloperskie (Docker Compose)}
Do lokalnego uruchomienia projektu wykorzystujemy plik \texttt{docker-compose.yml} w katalogu głównym repozytorium. Uruchamiane są dwa serwisy:
\begin{itemize}
\item \textbf{wastefree-api} — obraz budowany z katalogu \texttt{API}, ekspozycja \texttt{5001:5001}, zmienne: \texttt{ASPNETCORE\_ENVIRONMENT=Docker} oraz \texttt{ASPNETCORE\_URLS=http://+:5001}.
\item \textbf{wastefree-ui} — obraz budowany z katalogu \texttt{UI}, ekspozycja \texttt{4200:80}, zależność od \textbf{wastefree-api}.
\end{itemize}
Skład uruchamiamy poleceniem \texttt{docker compose up} (domyślnie bez bazy SQL Server, ponieważ lokalnie używamy SQLite). Porty są zgodne z lokalnym developmentem: API 5001, UI 4200.
\subsection{Środowiska CI/CD i hosting}
Produkcja i pipeline'y CI/CD działają na hostingu \textbf{Mikr.us}, gdzie aplikacje są uruchamiane jako kontenery Docker. Za automatyzację odpowiada \textbf{GitHub Actions} w katalogu \texttt{.github/workflows}:

\begin{itemize}
\item \textbf{api-cicd.yml}: wyzwalany na push do \texttt{main} lub ręcznie. Kroki: checkout, instalacja .NET 9, \texttt{dotnet restore/build/publish}, budowa obrazu \texttt{wastefree-api:latest}, logowanie do DockerHub, push obrazu, a następnie SSH na Mikr.us (\texttt{appleboy/ssh-action}) i restart kontenera \textbf{wastefree-api} z mapowaniem portu \texttt{8080:8080}. Sekretne zmienne środowiskowe są przekazywane jako \texttt{-e} do kontenera.
\item \textbf{ui-cicd.yml}: analogiczny pipeline dla frontendu. Kroki: checkout, Node.js 20, \texttt{npm ci}, \texttt{npm run build}, budowa obrazu \texttt{wastefree-ui:latest}, push do DockerHub, SSH na Mikr.us i restart kontenera \textbf{wastefree-ui} z ekspozycją \texttt{5000:80}.
\item \textbf{api-pr-ci.yml} i \textbf{ui-pr-ci.yml}: walidacje dla pull requestów do \texttt{main}. Budują odpowiednio API i UI (restore/build/publish lub \texttt{npm ci}/\texttt{npm run build}), weryfikując, że zmiany nie psują procesu budowy. Nie wykonują wdrożenia ani publikacji obrazów.
\end{itemize}

Proces wdrożenia na Mikr.us przebiega bez dodatkowych orkiestratorów: po zalogowaniu przez SSH istniejące kontenery są zatrzymywane i usuwane, pobierany jest najnowszy obraz z DockerHub, a następnie uruchamiany jest nowy kontener z flagą \texttt{--restart unless-stopped}. Po wdrożeniu wykonywany jest \texttt{docker image prune -f} w celu oczyszczenia nieużywanych warstw.
\subsection{Konfiguracja zmiennych środowiskowych}
Kluczowe sekrety wykorzystywane w pipeline'ach i kontenerach (przechowywane w GitHub Secrets, przekazywane do \texttt{docker run}):
\begin{itemize}
\item \texttt{ConnectionStrings\_\_Database} — pełny connection string do bazy produkcyjnej (MSSQL).
\item \texttt{ConnectionStrings\_\_BlobStorage} — dane dostępu do Azure Blob Storage na potrzeby plików.
\item \texttt{Integrations\_\_Smtp\_\_Password} — hasło do serwera SMTP używanego do wysyłki e-maili.
\item \texttt{Security\_\_AesEncryptionKey} — klucz dla symetrycznego szyfrowania wrażliwych danych.
\item \texttt{TickerQBasicAuth\_\_Username} / \texttt{TickerQBasicAuth\_\_Password} — dane do integracji TickerQ.
\item \texttt{Security\_\_Jwt\_\_Key} — klucz do podpisywania tokenów JWT.
\item \texttt{DOCKERHUB\_USERNAME} / \texttt{DOCKERHUB\_TOKEN} — uwierzytelnienie push/pull obrazów.
\item \texttt{DEPLOY\_HOST}, \texttt{DEPLOY\_USER}, \texttt{DEPLOY\_PORT}, \texttt{SSH\_PRIVATE\_KEY} — parametry połączenia SSH do hostingu Mikr.us.
\end{itemize}

W środowisku Mikr.us wartości te są mapowane na zmienne kontenera. Minimalny zestaw dla uruchomienia API: connection string do bazy, klucz JWT, klucz AES oraz hasło SMTP. UI nie wymaga sekretnych zmiennych (statyczny build), korzysta z API pod wskazanym hostem/portem.

\section{Dokumentacja kodu}
\subsection{Backend (.NET)}
\subsubsection{Wstęp i umówienie architektury}
\subsubsection{Warstwa Domain (encje, agregaty, interfejsy)}
\subsubsection{Warstwa Application}
\paragraph{Use case'y i mediator}
\paragraph{DTO i walidacje}
\paragraph{Usługi pomocnicze i serwisy}
\subsubsection{Warstwa API}
\paragraph{Minimal API i middleware}
\paragraph{Autoryzacja JWT i SignalR}
\paragraph{OpenAPI, lokalizacja (PL/EN) i konfiguracja}
\subsubsection{Warstwa Infrastructure}
\paragraph{EF Core i migracje}
\paragraph{Integracje (Azure Blob Storage, SMTP, Nominatim)}
\paragraph{Harmonogramy zadań (Quartz)}

\subsection{Frontend (Angular)}
\subsubsection{Architektura i stan (sygnały, rxjs)}
\paragraph{Konfiguracja i routing}
\paragraph{Stan: sygnały i strumienie rxjs}
\subsubsection{Komponenty}
\paragraph{Portal/home, grupy i zgody admina}
\paragraph{Portfel, zamówienia i odbiory}
\paragraph{Inbox i chat (SignalR)}
\subsubsection{Nawigacja i bezpieczeństwo}
\paragraph{Routing, guardy}
\subsubsection{Serwisy i integracje}
\paragraph{Serwisy API}
\paragraph{SignalR, loader i obsługa błędów}
\subsubsection{Interceptory i i18n}
\paragraph{Auth, error, locale}
\paragraph{pl/en, zasoby i tłumaczenia}
\subsubsection{Środowiska i build}

\subsection{CI/CD}
\subsubsection{Pipelines API}
\subsubsection{Pipelines UI}
\subsubsection{Konteneryzacja i obrazy}


\renewcommand\refname{Literatura (jeżeli wymagana)}
\bibliography{references}
\addcontentsline{toc}{section}{Literatura}
% --------------------------------------------------------------------
%%%%%%% odkomentować gdy bibliografia ma być wewnątrz dokumentu
% --------------------------------------------------------------------
%\begin{thebibliography}{11}
%
%\addcontentsline{toc}{section}{Literatura}
%
%\bibitem{ZAN}
%C. Zannoni and P. Pasini, 
%\emph{Advances in the Computer Simulatons of Liquid Crystals}, Kluwer Academic Publishers, 2000.
%
%\end{thebibliography}

\end{document}

