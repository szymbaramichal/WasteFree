<nav *ngIf="visible" class="topbar navbar navbar-expand-lg" [ngClass]="currentUser.user()?.role == userRole.GarbageAdmin ? 'role-garbadmin' : 'role-user'">
  <div class="container-fluid topbar-inner">
    <a class="navbar-brand brand text-white" routerLink="/portal">{{ 'topbar.portalTitle' | translate }}</a>
    <button class="navbar-toggler" type="button" (click)="navOpen = !navOpen" [attr.aria-expanded]="navOpen" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" [class.show]="navOpen">
      <div class="d-flex align-items-center gap-2 ms-auto flex-wrap">
        <div class="inbox-slot order-lg-2" *ngIf="currentUser.user()">
          <button class="inbox-pill link" (click)="openInbox()" [title]="('topbar.openInbox' | translate)" [ngClass]="{'jiggle': animateInbox}">
            <img src="/assets/images/bell.svg" alt="inbox" width="18" height="18" class="inbox-icon" aria-hidden="true" />
            <span class="inbox-count" *ngIf="inbox.counter()">{{ inbox.counter() }}</span>
          </button>
        </div>
        <div class="wallet-slot order-lg-2" *ngIf="(walletBalance$ | async) !== null">
          <a class="wallet-pill link" routerLink="/portal/wallet" [title]="('topbar.openWallet' | translate)">
            <img src="/assets/images/wallet.svg" alt="wallet" width="18" height="18" class="wallet-icon" aria-hidden="true" />
            <div class="wallet-value ms-2">
              <div class="amount">{{ (walletBalance$ | async) | number:'1.2-2' }}</div>
              <div class="currency">PLN</div>
            </div>
          </a>
        </div>
        <div class="lang-slot order-lg-1">
          <app-language-switcher></app-language-switcher>
        </div>
        <div class="user-info order-lg-3" *ngIf="currentUser.user() as u">
          <div class="user-pill">
            <ng-container *ngIf="!avatarFailed && avatarUrlOrFallback(u) as avatar; else defaultAvatar">
              <img [src]="avatar" alt="" width="36" height="36" class="user-avatar-img" (error)="onAvatarError()" (load)="onAvatarLoad()" />
            </ng-container>
            <ng-template #defaultAvatar>
              <div class="user-avatar-fallback" aria-hidden="true">{{ (u.username || '?').slice(0,1).toUpperCase() }}</div>
            </ng-template>
            <div class="user-text">
              <div class="name"><a class="text-white text-decoration-underline" routerLink="/portal/profile">{{ u.username }}</a></div>
              <div class="role">{{ roleKeyMap[u.role] | translate }}</div>
            </div>
            <button class="btn btn-outline-light btn-sm logout-btn" (click)="logout()" [title]="('topbar.logout' | translate)">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              <span class="d-none d-xl-inline ms-1">{{ 'topbar.logout' | translate }}</span>
            </button>
          </div>
        </div>
        <div class="user-info order-lg-3" *ngIf="!currentUser.user()">
          <a class="link" routerLink="/portal">{{ 'topbar.goPortal' | translate }}</a>
        </div>
      </div>
    </div>
  </div>
</nav>