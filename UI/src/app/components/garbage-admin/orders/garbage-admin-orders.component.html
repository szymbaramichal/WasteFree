<div class="dispatch-view">
  <div class="dispatch-header">
    <div class="dispatch-header__text">
      <h1 class="h3 mb-1">{{ 'garbageAdminOrders.title' | translate }}</h1>
      <p class="text-muted mb-0">{{ 'garbageAdminOrders.lead' | translate }}</p>
    </div>

    <button
      type="button"
      class="btn btn-outline-primary d-flex align-items-center gap-2"
      (click)="refreshAll()"
      [disabled]="waitingLoading() || currentLoading()"
    >
      <span class="refresh-icon" aria-hidden="true"></span>
      <span>{{ 'garbageAdminOrders.actions.refresh' | translate }}</span>
    </button>
  </div>

  <section class="orders-section">
    <header class="orders-section__header">
      <div>
        <h2 class="h4 mb-1">{{ 'garbageAdminOrders.waiting.title' | translate }}</h2>
        <p class="text-muted mb-0">{{ 'garbageAdminOrders.waiting.lead' | translate }}</p>
      </div>
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary"
        (click)="retryWaiting()"
        [disabled]="waitingLoading()"
      >
        {{ 'garbageAdminOrders.actions.retry' | translate }}
      </button>
    </header>

    <div *ngIf="waitingLoading()" class="orders-state orders-state--loading">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <small class="text-muted">{{ 'garbageAdminOrders.loading' | translate }}</small>
    </div>

    <div *ngIf="!waitingLoading() && waitingError()" class="orders-state orders-state--error">
      <p class="mb-2">{{ (waitingError() ?? 'garbageAdminOrders.waiting.loadError') | translate }}</p>
      <button type="button" class="btn btn-sm btn-primary" (click)="retryWaiting()">
        {{ 'garbageAdminOrders.actions.retry' | translate }}
      </button>
    </div>

    <div *ngIf="!waitingLoading() && !waitingError() && waitingItems().length === 0" class="orders-state orders-state--empty">
      <div class="orders-state__icon" aria-hidden="true">&#128210;</div>
      <h3 class="h6 mb-1">{{ 'garbageAdminOrders.waiting.empty.title' | translate }}</h3>
      <p class="text-muted mb-0">{{ 'garbageAdminOrders.waiting.empty.lead' | translate }}</p>
    </div>

    <div *ngIf="!waitingLoading() && !waitingError() && waitingItems().length" class="orders-list">
      <article
        class="order-card"
        *ngFor="let item of waitingItems(); trackBy: trackById"
        [class.order-card--priority]="item.isHighPriority"
      >
        <header class="order-card__header">
          <div>
            <span class="order-card__code">{{ item.orderNumber }}</span>
            <div class="order-card__group">
              <span class="order-card__group-name">
                {{ item.groupName || ('garbageAdminOrders.group.unknown' | translate) }}
              </span>
              <span *ngIf="item.isPrivateGroup" class="order-card__group-tag">
                {{ 'garbageAdminOrders.group.private' | translate }}
              </span>
            </div>
          </div>
          <span class="badge text-uppercase" [ngClass]="item.statusClass">{{ item.statusKey | translate }}</span>
        </header>

        <div class="order-card__body">
          <div class="order-card__summary">
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.pickupOption' | translate }}</span>
              <span class="order-card__value">{{ item.pickupOptionKey | translate }}</span>
            </div>
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.schedule' | translate }}</span>
              <span class="order-card__value">
                <ng-container *ngIf="item.schedule; else waitingNoSchedule">
                  <span class="me-2 text-uppercase small fw-semibold">{{ scheduleKey(item) | translate }}</span>
                  <time>{{ item.schedule | date:'medium' }}</time>
                </ng-container>
              </span>
            </div>
            <div class="order-card__row" *ngIf="item.containerSizeKey">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.containerSize' | translate }}</span>
              <span class="order-card__value">{{ item.containerSizeKey | translate }}</span>
            </div>
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.cost' | translate }}</span>
              <span class="order-card__value">{{ item.cost | currency:'PLN':'symbol':'1.2-2' }}</span>
            </div>
            <div class="order-card__row" *ngIf="item.distance !== null">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.distance' | translate }}</span>
              <span class="order-card__value">{{ item.distance | number:'1.1-1' }} km</span>
            </div>
          </div>

          <ul class="order-card__flags">
            <li *ngIf="item.isHighPriority" class="order-card__flag order-card__flag--priority">
              {{ 'garbageAdminOrders.badges.highPriority' | translate }}
            </li>
            <li *ngIf="item.collectingService" class="order-card__flag">
              {{ 'garbageAdminOrders.badges.collectingService' | translate }}
            </li>
          </ul>
        </div>

        <div class="order-card__participants">
          <h3 class="h6 mb-2">{{ 'garbageAdminOrders.participants.title' | translate:{ count: item.raw.users.length } }}</h3>
          <ul>
            <li *ngFor="let user of item.raw.users">
              <div class="participant__name">
                {{ user.username || ('garbageAdminOrders.participants.unknown' | translate) }}
              </div>
              <div class="participant__meta">
                <span
                  class="participant__status"
                  [class.participant__status--accepted]="user.hasAcceptedPayment"
                  [class.participant__status--pending]="!user.hasAcceptedPayment"
                >
                  {{ user.hasAcceptedPayment
                    ? ('garbageAdminOrders.participants.acceptedPayment' | translate)
                    : ('garbageAdminOrders.participants.pendingPayment' | translate) }}
                </span>
                <span class="participant__share">
                  {{ 'garbageAdminOrders.participants.shareAmount' | translate }}:
                  <strong>{{ user.shareAmount | number:'1.2-2' }} PLN</strong>
                </span>
                <span *ngIf="user.additionalUtilizationFeeShareAmount !== null" class="participant__share">
                  {{ 'garbageAdminOrders.participants.utilizationShareAmount' | translate }}:
                  <strong>{{ user.additionalUtilizationFeeShareAmount | number:'1.2-2' }} PLN</strong>
                </span>
              </div>
            </li>
          </ul>
        </div>

        <footer class="order-card__footer">
          <button
            type="button"
            class="btn btn-primary"
            (click)="acceptOrder(item)"
            [disabled]="isAccepting(item.id)"
          >
            <span *ngIf="isAccepting(item.id)" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ 'garbageAdminOrders.accept.cta' | translate }}
          </button>
        </footer>
      </article>
    </div>

    <ng-template #waitingNoSchedule>
      <span class="text-muted">{{ 'garbageAdminOrders.schedule.missing' | translate }}</span>
    </ng-template>

    <div
      *ngIf="!waitingLoading() && !waitingError() && waitingPageMeta().totalCount > 0"
      class="orders-pagination"
    >
      <div class="orders-pagination__info">
        {{ 'garbageAdminOrders.pagination.label' | translate:{ start: waitingPageMeta().start, end: waitingPageMeta().end, total: waitingPageMeta().totalCount } }}
      </div>
      <div class="orders-pagination__controls">
        <button type="button" class="page-btn" (click)="previousWaitingPage()" [disabled]="!waitingPageMeta().hasPrevious">
          {{ 'garbageAdminOrders.pagination.previous' | translate }}
        </button>
        <span class="orders-pagination__page">
          {{ 'garbageAdminOrders.pagination.page' | translate:{ current: waitingPageMeta().currentPage || 1, total: waitingPageMeta().totalPages || 1 } }}
        </span>
        <button type="button" class="page-btn" (click)="nextWaitingPage()" [disabled]="!waitingPageMeta().hasNext">
          {{ 'garbageAdminOrders.pagination.next' | translate }}
        </button>
      </div>
    </div>
  </section>

  <section class="orders-section mt-5">
    <header class="orders-section__header">
      <div>
        <h2 class="h4 mb-1">{{ 'garbageAdminOrders.current.title' | translate }}</h2>
        <p class="text-muted mb-0">{{ 'garbageAdminOrders.current.lead' | translate }}</p>
      </div>
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary"
        (click)="retryCurrent()"
        [disabled]="currentLoading()"
      >
        {{ 'garbageAdminOrders.actions.retry' | translate }}
      </button>
    </header>

    <div *ngIf="currentLoading()" class="orders-state orders-state--loading">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <small class="text-muted">{{ 'garbageAdminOrders.loading' | translate }}</small>
    </div>

    <div *ngIf="!currentLoading() && currentError()" class="orders-state orders-state--error">
      <p class="mb-2">{{ (currentError() ?? 'garbageAdminOrders.current.loadError') | translate }}</p>
      <button type="button" class="btn btn-sm btn-primary" (click)="retryCurrent()">
        {{ 'garbageAdminOrders.actions.retry' | translate }}
      </button>
    </div>

    <div *ngIf="!currentLoading() && !currentError() && currentItems().length === 0" class="orders-state orders-state--empty">
      <div class="orders-state__icon" aria-hidden="true">&#128666;</div>
      <h3 class="h6 mb-1">{{ 'garbageAdminOrders.current.empty.title' | translate }}</h3>
      <p class="text-muted mb-0">{{ 'garbageAdminOrders.current.empty.lead' | translate }}</p>
    </div>

    <div *ngIf="!currentLoading() && !currentError() && currentItems().length" class="orders-list">
      <article
        class="order-card order-card--current"
        *ngFor="let item of currentItems(); trackBy: trackById"
        [class.order-card--priority]="item.isHighPriority"
      >
        <header class="order-card__header">
          <div>
            <span class="order-card__code">{{ item.orderNumber }}</span>
            <div class="order-card__group">
              <span class="order-card__group-name">
                {{ item.groupName || ('garbageAdminOrders.group.unknown' | translate) }}
              </span>
              <span *ngIf="item.isPrivateGroup" class="order-card__group-tag">
                {{ 'garbageAdminOrders.group.private' | translate }}
              </span>
            </div>
          </div>
          <span class="badge text-uppercase" [ngClass]="item.statusClass">{{ item.statusKey | translate }}</span>
        </header>

        <div class="order-card__body">
          <div class="order-card__summary">
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.pickupOption' | translate }}</span>
              <span class="order-card__value">{{ item.pickupOptionKey | translate }}</span>
            </div>
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.schedule' | translate }}</span>
              <span class="order-card__value">
                <ng-container *ngIf="item.schedule; else currentNoSchedule">
                  <span class="me-2 text-uppercase small fw-semibold">{{ scheduleKey(item) | translate }}</span>
                  <time>{{ item.schedule | date:'medium' }}</time>
                </ng-container>
              </span>
            </div>
            <div class="order-card__row" *ngIf="item.containerSizeKey">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.containerSize' | translate }}</span>
              <span class="order-card__value">{{ item.containerSizeKey | translate }}</span>
            </div>
            <div class="order-card__row">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.cost' | translate }}</span>
              <span class="order-card__value">{{ item.cost | currency:'PLN':'symbol':'1.2-2' }}</span>
            </div>
            <div class="order-card__row" *ngIf="item.distance !== null">
              <span class="order-card__label">{{ 'garbageAdminOrders.summary.distance' | translate }}</span>
              <span class="order-card__value">{{ item.distance | number:'1.1-1' }} km</span>
            </div>
          </div>

          <ul class="order-card__flags">
            <li *ngIf="item.isHighPriority" class="order-card__flag order-card__flag--priority">
              {{ 'garbageAdminOrders.badges.highPriority' | translate }}
            </li>
            <li *ngIf="item.collectingService" class="order-card__flag">
              {{ 'garbageAdminOrders.badges.collectingService' | translate }}
            </li>
            <li *ngIf="item.raw.utilizationFeeAmount !== null" class="order-card__flag order-card__flag--fee">
              {{ 'garbageAdminOrders.badges.utilizationFeePending' | translate }}
            </li>
          </ul>
        </div>

        <div class="order-card__participants">
          <h3 class="h6 mb-2">{{ 'garbageAdminOrders.participants.title' | translate:{ count: item.raw.users.length } }}</h3>
          <ul>
            <li *ngFor="let user of item.raw.users">
              <div class="participant__name">
                {{ user.username || ('garbageAdminOrders.participants.unknown' | translate) }}
              </div>
              <div class="participant__meta">
                <span
                  class="participant__status"
                  [class.participant__status--accepted]="user.hasAcceptedPayment"
                  [class.participant__status--pending]="!user.hasAcceptedPayment"
                >
                  {{ user.hasAcceptedPayment
                    ? ('garbageAdminOrders.participants.acceptedPayment' | translate)
                    : ('garbageAdminOrders.participants.pendingPayment' | translate) }}
                </span>
                <span class="participant__share">
                  {{ 'garbageAdminOrders.participants.shareAmount' | translate }}:
                  <strong>{{ user.shareAmount | number:'1.2-2' }} PLN</strong>
                </span>
                <span *ngIf="user.additionalUtilizationFeeShareAmount !== null" class="participant__share">
                  {{ 'garbageAdminOrders.participants.utilizationShareAmount' | translate }}:
                  <strong>{{ user.additionalUtilizationFeeShareAmount | number:'1.2-2' }} PLN</strong>
                </span>
              </div>
            </li>
          </ul>
        </div>
      </article>
    </div>

    <ng-template #currentNoSchedule>
      <span class="text-muted">{{ 'garbageAdminOrders.schedule.missing' | translate }}</span>
    </ng-template>

    <div
      *ngIf="!currentLoading() && !currentError() && currentPageMeta().totalCount > 0"
      class="orders-pagination"
    >
      <div class="orders-pagination__info">
        {{ 'garbageAdminOrders.pagination.label' | translate:{ start: currentPageMeta().start, end: currentPageMeta().end, total: currentPageMeta().totalCount } }}
      </div>
      <div class="orders-pagination__controls">
        <button type="button" class="page-btn" (click)="previousCurrentPage()" [disabled]="!currentPageMeta().hasPrevious">
          {{ 'garbageAdminOrders.pagination.previous' | translate }}
        </button>
        <span class="orders-pagination__page">
          {{ 'garbageAdminOrders.pagination.page' | translate:{ current: currentPageMeta().currentPage || 1, total: currentPageMeta().totalPages || 1 } }}
        </span>
        <button type="button" class="page-btn" (click)="nextCurrentPage()" [disabled]="!currentPageMeta().hasNext">
          {{ 'garbageAdminOrders.pagination.next' | translate }}
        </button>
      </div>
    </div>
  </section>
</div>
