<div class="container-fluid px-3 order-details">
  <div class="order-details__header">
    <button
      type="button"
      class="btn btn-link order-details__back"
      (click)="navigateBack()"
      [attr.aria-label]="'common.back' | translate"
    >
      <span class="order-details__back-label">{{ 'common.back' | translate }}</span>
    </button>
  </div>

  <div *ngIf="loading()" class="order-details__loading">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div class="small text-muted">{{ 'myPickups.loading' | translate }}</div>
  </div>

  <div *ngIf="!loading() && error()" class="alert alert-danger" role="alert">
    {{ error() }}
  </div>

  <ng-container *ngIf="!loading() && !error() && order() as detail">
    <div class="card order-details__card border-0 shadow-lg">
      <div class="order-details__hero gradient-groups text-white position-relative overflow-hidden">
        <div class="order-details__hero-content d-flex align-items-start justify-content-between flex-wrap gap-3">
          <div class="order-details__hero-heading d-flex align-items-center gap-3 flex-wrap">
            <div class="order-details__hero-icon d-inline-flex align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75V3a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 3v.75M4.5 6h15M6 6v14.25A1.5 1.5 0 0 0 7.5 21.75h9a1.5 1.5 0 0 0 1.5-1.5V6M10 10.5v7.5M14 10.5v7.5" />
              </svg>
            </div>
            <div>
              <p class="order-details__hero-label text-uppercase small fw-semibold mb-1">{{ 'myPickups.details.title' | translate }}</p>
              <h1 class="order-details__hero-title mb-1">#{{ orderCode(detail) }}</h1>
              <small class="opacity-75">{{ 'myPickups.details.subtitle' | translate }}</small>
            </div>
          </div>
          <span
            *ngIf="detail.garbageOrderStatus !== orderStatus.WaitingForUtilizationFee"
            [class]="statusClass(detail.garbageOrderStatus)"
          >
            {{ statusTranslationKey(detail.garbageOrderStatus) | translate }}
          </span>
        </div>
        <div class="header-accent"></div>
      </div>
      <div class="card-body">
        <header class="order-details__heading">
          <div class="order-details__status">
            <span class="order-details__status-label text-uppercase small fw-semibold">{{ 'myPickups.table.status' | translate }}</span>
            <span
              class="order-details__status-chip"
              [ngClass]="statusClass(detail.garbageOrderStatus)"
            >
              {{ statusTranslationKey(detail.garbageOrderStatus) | translate }}
            </span>
          </div>
        </header>

        <section class="order-details__section">
          <h2 class="h6 text-uppercase fw-semibold small mb-3">{{ 'myPickups.details.summary.title' | translate }}</h2>
          <dl class="row small mb-0">
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.pickupDate' | translate }}</dt>
              <dd class="fw-semibold">{{ detail.pickupDate | date:'fullDate' }} • {{ detail.pickupDate | date:'shortTime' }}</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.pickupType' | translate }}</dt>
              <dd class="fw-semibold">{{ pickupOptionKey(detail.pickupOption) | translate }}</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.cost' | translate }}</dt>
              <dd class="fw-semibold">{{ detail.cost | number:'1.2-2' }} PLN</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.group' | translate }}</dt>
              <dd class="fw-semibold">
                <a class="group-link" [routerLink]="['/portal/groups', detail.garbageGroupId]">
                  <span class="group-link__label">{{ detail.garbageGroupName || '—' }}</span>
                </a>
              </dd>
            </div>
            <div class="col-md-6 mb-3" *ngIf="detail.collectingService">
              <dt class="text-muted">{{ 'myPickups.details.summary.collectingService' | translate }}</dt>
              <dd class="fw-semibold">{{ 'common.yes' | translate }}</dd>
            </div>
            <div class="col-md-6 mb-3" *ngIf="detail.isHighPriority">
              <dt class="text-muted">{{ 'myPickups.details.summary.highPriority' | translate }}</dt>
              <dd class="fw-semibold">{{ 'myPickups.details.summary.priorityLabel' | translate }}</dd>
            </div>
          </dl>
        </section>

        <section
          class="order-details__section order-details__admin"
          *ngIf="detail.assignedGarbageAdminId"
        >
          <div class="order-details__admin-content">
            <div class="order-details__admin-avatar">
              <ng-container *ngIf="assignedAdminAvatar(); else adminAvatarFallback">
                <img
                  [src]="assignedAdminAvatar()!"
                  [attr.alt]="assignedAdminAvatarAlt(detail)"
                  class="order-details__admin-avatar-img"
                />
              </ng-container>
              <ng-template #adminAvatarFallback>
                <span
                  *ngIf="assignedAdminAvatarLoading(); else adminInitials"
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                <ng-template #adminInitials>
                  <span>{{ assignedAdminInitials(detail) }}</span>
                </ng-template>
              </ng-template>
            </div>
            <div class="order-details__admin-info">
              <h2 class="h6 text-uppercase fw-semibold small mb-1">
                {{ 'myPickups.details.assignedAdmin.title' | translate }}
              </h2>
              <p class="mb-1 text-muted small">
                {{ 'myPickups.details.assignedAdmin.lead' | translate }}
              </p>
              <div class="order-details__admin-name fw-semibold">
                {{ assignedAdminDisplayName(detail) }}
              </div>
            </div>
          </div>
        </section>

        <section
          class="order-details__section order-details__utilization"
          *ngIf="detail.garbageOrderStatus === orderStatus.WaitingForUtilizationFee"
        >
          <div class="order-details__utilization-header">
            <div>
              <p class="text-uppercase small fw-semibold mb-1">{{ 'myPickups.details.utilization.title' | translate }}</p>
              <p class="mb-0 text-muted small">{{ 'myPickups.details.utilization.description' | translate }}</p>
            </div>
            <span class="badge" [ngClass]="hasPaidUtilizationFee() ? 'bg-success' : 'bg-warning text-dark'">
              {{ hasPaidUtilizationFee() ? ('myPickups.details.utilization.paid' | translate) : ('myPickups.details.utilization.pending' | translate) }}
            </span>
          </div>
          <div class="order-details__utilization-grid">
            <dl class="order-details__utilization-metrics">
              <div>
                <dt>{{ 'myPickups.details.utilization.outstanding' | translate }}</dt>
                <dd>{{ utilizationOutstandingAmount() | number:'1.2-2' }} PLN</dd>
              </div>
              <div>
                <dt>{{ 'myPickups.details.utilization.share' | translate }}</dt>
                <dd>{{ utilizationShareAmount() | number:'1.2-2' }} PLN</dd>
              </div>
            </dl>
            <div class="order-details__utilization-action">
              <button
                type="button"
                class="btn btn-primary w-100"
                (click)="payForUtilizationFee()"
                [disabled]="!canPayUtilizationFee() || utilizationPaying()"
              >
                <span *ngIf="utilizationPaying()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>{{ 'myPickups.details.utilization.payCta' | translate }}</span>
              </button>
              <small class="text-muted d-block mt-2" *ngIf="!canPayUtilizationFee()">
                {{
                  hasPaidUtilizationFee()
                    ? ('myPickups.details.utilization.paidHint' | translate)
                    : (utilizationShareAmount() > 0
                      ? ('myPickups.details.utilization.processingHint' | translate)
                      : ('myPickups.details.utilization.noShareHint' | translate))
                }}
              </small>
            </div>
          </div>
        </section>

        <section
          class="order-details__section order-details__payment"
          *ngIf="detail.garbageOrderStatus === orderStatus.WaitingForPayment"
        >
          <div class="order-details__payment-grid">
            <div class="order-details__payment-summary">
              <div class="order-details__payment-label d-inline-flex align-items-center gap-2 mb-3">
                <span class="badge rounded-pill order-details__payment-indicator" [class.order-details__payment-indicator--paid]="hasAcceptedPayment()"></span>
                <h2 class="h6 text-uppercase fw-semibold small mb-0">{{ 'myPickups.details.payment.title' | translate }}</h2>
              </div>
              <dl class="order-details__payment-details">
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.summary.cost' | translate }}</dt>
                  <dd>{{ detail.cost | number:'1.2-2' }} PLN</dd>
                </div>
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.participants.share' | translate }}</dt>
                  <dd>{{ pickupShareAmount() | number:'1.2-2' }} PLN</dd>
                </div>
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.payment.title' | translate }}</dt>
                  <dd>
                    <span class="order-details__payment-status" [ngClass]="hasAcceptedPayment() ? 'is-paid' : 'is-pending'">
                      {{ hasAcceptedPayment() ? ('myPickups.details.payment.accepted' | translate) : ('myPickups.details.payment.pending' | translate:{ amount: pickupShareAmount() | number:'1.2-2' }) }}
                    </span>
                  </dd>
                </div>
              </dl>
            </div>
            <div class="order-details__payment-cta">
              <button
                type="button"
                class="btn btn-success btn-elevated w-100"
                (click)="payForOrder()"
                [disabled]="!canPay() || paying()"
              >
                <span *ngIf="paying()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>{{ 'myPickups.details.payCta' | translate }}</span>
              </button>
            </div>
          </div>
        </section>

        <section class="order-details__section order-details__section--participants">
          <h2 class="h6 text-uppercase fw-semibold small mb-3">{{ 'myPickups.details.participants.title' | translate }}</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">{{ 'myPickups.details.participants.user' | translate }}</th>
                  <th scope="col" class="text-end">{{ 'myPickups.details.participants.share' | translate }}</th>
                  <th scope="col" class="text-end">{{ 'myPickups.details.participants.payment' | translate }}</th>
                  <th
                    scope="col"
                    class="text-end"
                    *ngIf="hasUtilizationFeeShares(detail)"
                  >
                    {{ 'myPickups.details.participants.utilizationShare' | translate }}
                  </th>
                  <th
                    scope="col"
                    class="text-end"
                    *ngIf="hasUtilizationFeeShares(detail)"
                  >
                    {{ 'myPickups.details.participants.utilizationPayment' | translate }}
                  </th>
                </tr>
              </thead>
              <tbody *ngIf="detail.users.length; else noParticipants">
                <tr *ngFor="let user of detail.users">
                  <td>
                    <span class="fw-semibold">
                      {{ user.username || user.userId }}
                    </span>
                  </td>
                  <td class="text-end">{{ user.shareAmount | number:'1.2-2' }} PLN</td>
                  <td class="text-end">
                    <span class="badge" [ngClass]="user.hasAcceptedPayment ? 'bg-success' : 'bg-warning text-dark'">
                      {{ user.hasAcceptedPayment ? ('myPickups.details.participants.paid' | translate) : ('myPickups.details.participants.pending' | translate) }}
                    </span>
                  </td>
                  <td class="text-end" *ngIf="hasUtilizationFeeShares(detail)">
                    <ng-container *ngIf="userHasUtilizationFeeShare(user); else noUtilShare">
                      {{ user.additionalUtilizationFeeShareAmount | number:'1.2-2' }} PLN
                    </ng-container>
                  </td>
                  <td class="text-end" *ngIf="hasUtilizationFeeShares(detail)">
                    <ng-container *ngIf="userHasUtilizationFeeShare(user); else noUtilStatus">
                      <span class="badge" [ngClass]="user.hasPaidAdditionalUtilizationFee ? 'bg-success' : 'bg-warning text-dark'">
                        {{ user.hasPaidAdditionalUtilizationFee ? ('myPickups.details.utilization.paid' | translate) : ('myPickups.details.utilization.pending' | translate) }}
                      </span>
                    </ng-container>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noUtilShare>—</ng-template>
          <ng-template #noUtilStatus>—</ng-template>
          <ng-template #noParticipants>
            <div class="alert alert-info small mb-0">{{ 'myPickups.details.participants.empty' | translate }}</div>
          </ng-template>
        </section>
      </div>
    </div>
  </ng-container>
</div>
