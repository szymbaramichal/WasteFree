<div class="container-fluid px-3 order-details">
  <div class="order-details__header">
    <button
      type="button"
      class="btn btn-link order-details__back"
      (click)="navigateBack()"
      [attr.aria-label]="'common.back' | translate"
    >
      <span class="order-details__back-label">{{ 'common.back' | translate }}</span>
    </button>
  </div>

  <div *ngIf="loading()" class="order-details__loading">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <div class="small text-muted">{{ 'myPickups.loading' | translate }}</div>
  </div>

  <div *ngIf="!loading() && error()" class="alert alert-danger" role="alert">
    {{ error() }}
  </div>

  <ng-container *ngIf="!loading() && !error() && order() as detail">
    <div class="card order-details__card border-0 shadow-lg">
      <div class="order-details__hero gradient-groups text-white position-relative overflow-hidden">
        <div class="order-details__hero-content d-flex align-items-start justify-content-between flex-wrap gap-3">
          <div class="order-details__hero-heading d-flex align-items-center gap-3 flex-wrap">
            <div class="order-details__hero-icon d-inline-flex align-items-center justify-content-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75V3a1.5 1.5 0 0 1 1.5-1.5h3A1.5 1.5 0 0 1 15 3v.75M4.5 6h15M6 6v14.25A1.5 1.5 0 0 0 7.5 21.75h9a1.5 1.5 0 0 0 1.5-1.5V6M10 10.5v7.5M14 10.5v7.5" />
              </svg>
            </div>
            <div>
              <p class="order-details__hero-label text-uppercase small fw-semibold mb-1">{{ 'myPickups.details.title' | translate }}</p>
              <h1 class="order-details__hero-title mb-1">#{{ orderCode(detail) }}</h1>
              <small class="opacity-75">{{ 'myPickups.details.subtitle' | translate }}</small>
            </div>
          </div>
          <span
            *ngIf="detail.garbageOrderStatus !== orderStatus.WaitingForUtilizationFee"
            [class]="statusClass(detail.garbageOrderStatus)"
          >
            {{ statusTranslationKey(detail.garbageOrderStatus) | translate }}
          </span>
        </div>
        <div class="header-accent"></div>
      </div>
      <div class="card-body">
        <header class="order-details__heading">
          <div class="order-details__status">
            <span class="order-details__status-label text-uppercase small fw-semibold">{{ 'myPickups.table.status' | translate }}</span>
            <span
              class="order-details__status-chip"
              [ngClass]="statusClass(detail.garbageOrderStatus)"
            >
              {{ statusTranslationKey(detail.garbageOrderStatus) | translate }}
            </span>
          </div>
        </header>

        <section class="order-details__section">
          <h2 class="h6 text-uppercase fw-semibold small mb-3">{{ 'myPickups.details.summary.title' | translate }}</h2>
          <dl class="row small mb-0">
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.pickupDate' | translate }}</dt>
              <dd class="fw-semibold">{{ detail.pickupDate | date:'fullDate' }} • {{ detail.pickupDate | date:'shortTime' }}</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.pickupType' | translate }}</dt>
              <dd class="fw-semibold">{{ pickupOptionKey(detail.pickupOption) | translate }}</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.cost' | translate }}</dt>
              <dd class="fw-semibold">{{ detail.cost | number:'1.2-2' }} PLN</dd>
            </div>
            <div class="col-md-6 mb-3">
              <dt class="text-muted">{{ 'myPickups.details.summary.group' | translate }}</dt>
              <dd class="fw-semibold">
                <a class="group-link" [routerLink]="['/portal/groups', detail.garbageGroupId]">
                  <span class="group-link__label">{{ detail.garbageGroupName || '—' }}</span>
                </a>
              </dd>
            </div>
            <div class="col-md-6 mb-3" *ngIf="detail.collectingService">
              <dt class="text-muted">{{ 'myPickups.details.summary.collectingService' | translate }}</dt>
              <dd class="fw-semibold">{{ 'common.yes' | translate }}</dd>
            </div>
            <div class="col-md-6 mb-3" *ngIf="detail.isHighPriority">
              <dt class="text-muted">{{ 'myPickups.details.summary.highPriority' | translate }}</dt>
              <dd class="fw-semibold">{{ 'myPickups.details.summary.priorityLabel' | translate }}</dd>
            </div>
          </dl>
        </section>

        <section class="order-details__section order-details__payment">
          <div class="order-details__payment-grid">
            <div class="order-details__payment-summary">
              <div class="order-details__payment-label d-inline-flex align-items-center gap-2 mb-3">
                <span class="badge rounded-pill order-details__payment-indicator" [class.order-details__payment-indicator--paid]="hasAcceptedPayment()"></span>
                <h2 class="h6 text-uppercase fw-semibold small mb-0">{{ 'myPickups.details.payment.title' | translate }}</h2>
              </div>
              <dl class="order-details__payment-details">
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.summary.cost' | translate }}</dt>
                  <dd>{{ detail.cost | number:'1.2-2' }} PLN</dd>
                </div>
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.participants.share' | translate }}</dt>
                  <dd>{{ pickupShareAmount() | number:'1.2-2' }} PLN</dd>
                </div>
                <div class="order-details__payment-row">
                  <dt>{{ 'myPickups.details.payment.title' | translate }}</dt>
                  <dd>
                    <span class="order-details__payment-status" [ngClass]="hasAcceptedPayment() ? 'is-paid' : 'is-pending'">
                      {{ hasAcceptedPayment() ? ('myPickups.details.payment.accepted' | translate) : ('myPickups.details.payment.pending' | translate:{ amount: pickupShareAmount() | number:'1.2-2' }) }}
                    </span>
                  </dd>
                </div>
              </dl>
            </div>
            <div class="order-details__payment-cta">
              <button
                type="button"
                class="btn btn-success btn-elevated w-100"
                (click)="payForOrder()"
                [disabled]="!canPay() || paying()"
              >
                <span *ngIf="paying()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>{{ 'myPickups.details.payCta' | translate }}</span>
              </button>
            </div>
          </div>
        </section>

        <section class="order-details__section order-details__section--participants">
          <h2 class="h6 text-uppercase fw-semibold small mb-3">{{ 'myPickups.details.participants.title' | translate }}</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">{{ 'myPickups.details.participants.user' | translate }}</th>
                  <th scope="col" class="text-end">{{ 'myPickups.details.participants.share' | translate }}</th>
                  <th scope="col" class="text-end">{{ 'myPickups.details.participants.payment' | translate }}</th>
                </tr>
              </thead>
              <tbody *ngIf="detail.users.length; else noParticipants">
                <tr *ngFor="let user of detail.users">
                  <td>
                    <span class="fw-semibold">
                      {{ user.username || user.userId }}
                    </span>
                  </td>
                  <td class="text-end">{{ user.shareAmount | number:'1.2-2' }} PLN</td>
                  <td class="text-end">
                    <span class="badge" [ngClass]="user.hasAcceptedPayment ? 'bg-success' : 'bg-warning text-dark'">
                      {{ user.hasAcceptedPayment ? ('myPickups.details.participants.paid' | translate) : ('myPickups.details.participants.pending' | translate) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noParticipants>
            <div class="alert alert-info small mb-0">{{ 'myPickups.details.participants.empty' | translate }}</div>
          </ng-template>
        </section>
      </div>
    </div>
  </ng-container>
</div>
