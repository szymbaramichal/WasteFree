<div class="profile-container container py-4 profile-page">
  <h1 class="h3 mb-3 page-title">{{ 'profile.title' | translate }}</h1>

  <div class="card shadow-sm mb-3 profile-card profile-intro animate-in">
    <div class="card-body">
      <ng-container *ngIf="!profileSvc.loading(); else loadingTpl">
        <ng-container *ngIf="profileSvc.profile() as p; else errorTpl">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              <div class="avatar" aria-hidden="true">{{ (p.username || '?').slice(0,1).toUpperCase() }}</div>
            </div>
            <div class="col">
              <div class="fw-semibold username">{{ p.username }}</div>
              <div class="muted small">ID: {{ p.userId }}</div>
            </div>
          </div>
        </ng-container>
      </ng-container>
      <ng-template #loadingTpl>
        <div class="muted">{{ 'loading' | translate }}</div>
      </ng-template>
      <ng-template #errorTpl>
        <div class="text-danger">{{ 'profile.loadError' | translate }}</div>
      </ng-template>
    </div>
  </div>

  <div class="card shadow-sm profile-card animate-in">
    <div class="card-header bg-gradient-teal text-white py-3 position-relative overflow-hidden profile-card-header">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-3.866 0-7 3.134-7 7 0 .552.448 1 1 1h12c.552 0 1-.448 1-1 0-3.866-3.134-7-7-7z" fill="currentColor"/>
          </svg>
          <span class="card-title mb-0">{{ 'profile.details' | translate }}</span>
        </div>
        <button class="btn btn-sm btn-outline-light btn-ghost" (click)="profileSvc.refresh()" [disabled]="profileSvc.loading()">{{ 'inbox.refresh' | translate }}</button>
      </div>
      <div class="header-accent"></div>
    </div>
    <div class="card-body">
      <dl class="row mb-0 details-list" *ngIf="profileSvc.profile() as p">
        <dt class="col-sm-3">{{ 'profile.username' | translate }}</dt>
        <dd class="col-sm-9">{{ p.username }}</dd>

        <dt class="col-sm-3">{{ 'profile.email' | translate }}</dt>
        <dd class="col-sm-9">{{ p.email }}</dd>

        <dt class="col-sm-3">{{ 'profile.description' | translate }}</dt>
        <dd class="col-sm-9">
          <div *ngIf="!editMode; else editTpl" class="d-flex align-items-center gap-2 flex-wrap">
            <div class="me-2">{{ p.description || '—' }}</div>
            <button class="btn btn-sm btn-outline-primary btn-ghost-primary" (click)="startEdit(p.description)">{{ 'common.edit' | translate }}</button>
          </div>
          <ng-template #editTpl>
            <div class="mb-2">
              <textarea class="form-control" rows="3" [(ngModel)]="draftDescription" [disabled]="saving"></textarea>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary d-inline-flex align-items-center btn-elevated" (click)="save()" [disabled]="saving" [attr.aria-busy]="saving">
                <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>{{ 'common.save' | translate }}</span>
              </button>
              <button class="btn btn-sm btn-outline-secondary btn-ghost" (click)="cancel()" [disabled]="saving">{{ 'common.cancel' | translate }}</button>
            </div>
          </ng-template>
        </dd>

        <dt class="col-sm-3">{{ 'profile.city' | translate }}</dt>
        <dd class="col-sm-9">
          <div class="row g-2 align-items-center" *ngIf="profileSvc.profile() as p">
            <div class="col-md-7">
              <div class="city-select-wrapper position-relative">
                <svg class="city-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill="currentColor"/>
                </svg>
                <select class="form-select city-select" [ngModel]="p.city" (ngModelChange)="onCityChanged($event)" [disabled]="citySaving">
                  <option [ngValue]="''">{{ 'profile.city.placeholder' | translate }}</option>
                  <option value="Warszawa">Warszawa</option>
                  <option value="Kraków">Kraków</option>
                  <option value="Łódź">Łódź</option>
                  <option value="Wrocław">Wrocław</option>
                  <option value="Poznań">Poznań</option>
                  <option value="Gdańsk">Gdańsk</option>
                  <option value="Szczecin">Szczecin</option>
                  <option value="Bydgoszcz">Bydgoszcz</option>
                  <option value="Lublin">Lublin</option>
                  <option value="Białystok">Białystok</option>
                  <option value="Nowy Sącz">Nowy Sącz</option>
                </select>
              </div>
            </div>
            <div class="col-md-5 d-flex align-items-center gap-2">
              <span class="city-pill" *ngIf="p.city && p.city.length > 0"><i class="bi bi-geo-alt-fill"></i>{{ p.city }}</span>
              <span class="spinner-border spinner-border-sm" *ngIf="citySaving" aria-hidden="true"></span>
            </div>
          </div>
        </dd>

        <dt class="col-sm-3">{{ 'profile.bankAccountNumber' | translate }}</dt>
        <dd class="col-sm-9">
          <div *ngIf="!editBank; else editBankTpl" class="d-flex align-items-center gap-2 flex-wrap">
            <span class="iban-pill mb-0"><code>{{ p.bankAccountNumber || '—' }}</code></span>
            <button class="btn btn-sm btn-outline-primary btn-ghost-primary" (click)="startEditBank(p.bankAccountNumber)">{{ 'common.edit' | translate }}</button>
          </div>
          <ng-template #editBankTpl>
            <div class="mb-2">
              <input type="text" class="form-control" [(ngModel)]="draftBank" [disabled]="savingBank" placeholder="PL11 2222 3333 4444 5555 6666" [class.is-invalid]="ibanInvalid" />
              <div class="invalid-feedback" *ngIf="ibanInvalid">
                {{ 'wallet.errors.invalidIban' | translate }}
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary d-inline-flex align-items-center btn-elevated" (click)="saveBank()" [disabled]="savingBank" [attr.aria-busy]="savingBank">
                <span *ngIf="savingBank" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>{{ 'common.save' | translate }}</span>
              </button>
              <button class="btn btn-sm btn-outline-secondary btn-ghost" (click)="cancelBank()" [disabled]="savingBank">{{ 'common.cancel' | translate }}</button>
            </div>
          </ng-template>
        </dd>
      </dl>
      <div *ngIf="!profileSvc.profile() && !profileSvc.loading()" class="text-muted">{{ 'profile.noData' | translate }}</div>
    </div>
  </div>
</div>
